{% extends "layouts/base.html" %}

{% block title %}Trading Bot - Market Data{% endblock %}

{% block header_text %}Market Overview{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- Initialize chart functions -->
<script>
    let priceChart = null;

    // Initialize chart with default data
    function initChart(symbol, timeframe) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        if (priceChart) {
            priceChart.destroy();
        }

        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: `${symbol} Price`,
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        // Load initial data
        updateChartData(symbol, timeframe);
    }

    // Update chart with new data
    async function updateChartData(symbol, timeframe) {
        try {
            const response = await fetch(`/api/market_data?symbol=${symbol}&timeframe=${timeframe}`);
            const data = await response.json();

            priceChart.data.labels = data.timestamps;
            priceChart.data.datasets[0].data = data.prices;
            priceChart.update();
        } catch (error) {
            console.error('Error fetching market data:', error);
        }
    }

    // Show chart for selected symbol
    function showChart(symbol) {
        const timeframe = document.getElementById('timeframe-select').value;
        document.getElementById('symbol-select').value = symbol;
        initChart(symbol, timeframe);
    }
</script>

<div class="row">
    <!-- Market Overview -->
    <div class="col-md-12 mb-4">
        <div class="dashboard-card">
            <h5><i class='bx bx-line-chart-down text-primary'></i> Market Overview</h5>
            <div class="table-responsive mt-3">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Price</th>
                            <th>24h Change</th>
                            <th>24h Volume</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for symbol in symbols %}
                        {% set price_data = latest_prices[symbol] %}
                        <tr>
                            <td>{{ symbol }}</td>
                            <td>${{ "%.2f"|format(price_data.price) }}</td>
                            <td class="text-{{ 'success' if price_data.change > 0 else 'danger' }}">
                                {{ "%.2f"|format(price_data.change) }}%
                            </td>
                            <td>{{ "%.2f"|format(price_data.volume) }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="showChart('{{ symbol }}')">
                                    <i class='bx bx-chart'></i> Chart
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not symbols %}
                        <tr>
                            <td colspan="5" class="text-center">No market data available</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Price Chart -->
    <div class="col-md-12">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center">
                <h5><i class='bx bx-chart text-info'></i> Price Chart</h5>
                <div>
                    <select id="timeframe-select" class="form-select form-select-sm d-inline-block w-auto me-2">
                        {% for tf in timeframes %}
                        <option value="{{ tf }}">{{ tf }}</option>
                        {% endfor %}
                    </select>
                    <select id="symbol-select" class="form-select form-select-sm d-inline-block w-auto">
                        {% for symbol in symbols %}
                        <option value="{{ symbol }}">{{ symbol }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Event listeners
    document.getElementById('symbol-select').addEventListener('change', function() {
        const symbol = this.value;
        const timeframe = document.getElementById('timeframe-select').value;
        initChart(symbol, timeframe);
    });

    document.getElementById('timeframe-select').addEventListener('change', function() {
        const symbol = document.getElementById('symbol-select').value;
        const timeframe = this.value;
        initChart(symbol, timeframe);
    });

    // WebSocket connection for real-time updates
    const ws = new WebSocket('ws://' + window.location.host + '/ws');
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'market_update') {
            const symbol = document.getElementById('symbol-select').value;
            const timeframe = document.getElementById('timeframe-select').value;
            updateChartData(symbol, timeframe);
        }
    };

    // Initialize chart with first symbol and timeframe
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('symbol-select').options.length > 0) {
            const symbol = document.getElementById('symbol-select').value;
            const timeframe = document.getElementById('timeframe-select').value;
            initChart(symbol, timeframe);
        }
    });
</script>
{% endblock %} 