{% extends "layouts/base.html" %}

{% block title %}Trading Bot - Market Analysis{% endblock %}

{% block header_text %}Market Analysis{% endblock %}

{% block content %}
<div class="row">
    <!-- Market Overview -->
    <div class="col-md-12">
        <div class="dashboard-card">
            <h5><i class='bx bx-globe text-primary'></i> Market Overview</h5>
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="mb-0">{{ market_stats.total_volume }}</h3>
                        <small class="text-muted">24h Volume</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="mb-0 text-{{ 'success' if market_stats.market_trend == 'Bullish' else 'danger' }}">
                            {{ market_stats.market_trend }}
                        </h3>
                        <small class="text-muted">Market Trend</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="mb-0">{{ market_stats.active_pairs }}</h3>
                        <small class="text-muted">Active Pairs</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="mb-0">{{ market_stats.volatility }}%</h3>
                        <small class="text-muted">Market Volatility</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Charts -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5><i class='bx bx-line-chart text-success'></i> Price Analysis</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="tradingPair">
                        {% for pair in trading_pairs %}
                        <option value="{{ pair }}">{{ pair }}</option>
                        {% endfor %}
                    </select>
                    <select class="form-select form-select-sm d-inline-block w-auto" id="timeframe">
                        <option value="1m">1 minute</option>
                        <option value="5m">5 minutes</option>
                        <option value="15m">15 minutes</option>
                        <option value="1h">1 hour</option>
                        <option value="4h">4 hours</option>
                        <option value="1d">1 day</option>
                    </select>
                </div>
            </div>
            <div id="priceChart" style="height: 400px;"></div>
        </div>
    </div>
</div>

<!-- Market Analysis -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="dashboard-card">
            <h5><i class='bx bx-bar-chart-alt-2 text-info'></i> Volume Analysis</h5>
            <div id="volumeChart" style="height: 300px;"></div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="dashboard-card">
            <h5><i class='bx bx-trending-up text-warning'></i> Trend Analysis</h5>
            <div id="trendChart" style="height: 300px;"></div>
        </div>
    </div>
</div>

<!-- Market Data -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h5><i class='bx bx-table text-primary'></i> Market Data</h5>
            <div class="table-responsive mt-4">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Trading Pair</th>
                            <th>Price</th>
                            <th>24h Change</th>
                            <th>24h High</th>
                            <th>24h Low</th>
                            <th>Volume</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pair in market_data %}
                        <tr>
                            <td>{{ pair.symbol }}</td>
                            <td>{{ pair.price }}</td>
                            <td class="text-{{ 'success' if pair.change >= 0 else 'danger' }}">
                                {{ pair.change }}%
                            </td>
                            <td>{{ pair.high }}</td>
                            <td>{{ pair.low }}</td>
                            <td>{{ pair.volume }}</td>
                            <td>
                                <span class="badge bg-{{ pair.trend_color }}">
                                    {{ pair.trend }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Technical Indicators -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h5><i class='bx bx-analyse text-warning'></i> Technical Indicators</h5>
            <div class="table-responsive mt-4">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Indicator</th>
                            <th>Value</th>
                            <th>Signal</th>
                            <th>Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for indicator in technical_indicators %}
                        <tr>
                            <td>{{ indicator.name }}</td>
                            <td>{{ indicator.value }}</td>
                            <td>
                                <span class="badge bg-{{ indicator.signal_color }}">
                                    {{ indicator.signal }}
                                </span>
                            </td>
                            <td>{{ indicator.updated_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Price chart
function updatePriceChart() {
    const pair = document.getElementById('tradingPair').value;
    const timeframe = document.getElementById('timeframe').value;
    
    fetch(`/api/market/price?pair=${pair}&timeframe=${timeframe}`)
        .then(response => response.json())
        .then(data => {
            const candlestick = {
                x: data.timestamps,
                open: data.open,
                high: data.high,
                low: data.low,
                close: data.close,
                type: 'candlestick',
                name: pair
            };

            const volume = {
                x: data.timestamps,
                y: data.volume,
                type: 'bar',
                name: 'Volume',
                marker: {
                    color: data.volume_colors
                },
                yaxis: 'y2'
            };

            const layout = {
                dragmode: 'zoom',
                showlegend: false,
                margin: { t: 20, l: 40, r: 40, b: 40 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    rangeslider: { visible: false },
                    showgrid: true,
                    gridcolor: '#f5f5f5'
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: '#f5f5f5'
                },
                yaxis2: {
                    showgrid: false,
                    overlaying: 'y',
                    side: 'right'
                }
            };

            Plotly.newPlot('priceChart', [candlestick, volume], layout);
        });
}

// Volume analysis chart
const volumeData = {
    x: {{ volume_data.timestamps | tojson }},
    y: {{ volume_data.values | tojson }},
    type: 'bar',
    marker: {
        color: '#4723D9'
    }
};

const volumeLayout = {
    margin: { t: 20, l: 40, r: 40, b: 40 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    xaxis: {
        showgrid: true,
        gridcolor: '#f5f5f5'
    },
    yaxis: {
        showgrid: true,
        gridcolor: '#f5f5f5',
        title: 'Volume'
    }
};

Plotly.newPlot('volumeChart', [volumeData], volumeLayout);

// Trend analysis chart
const trendData = {
    x: {{ trend_data.timestamps | tojson }},
    y: {{ trend_data.values | tojson }},
    type: 'scatter',
    mode: 'lines',
    line: {
        color: '#4723D9'
    }
};

const trendLayout = {
    margin: { t: 20, l: 40, r: 40, b: 40 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    xaxis: {
        showgrid: true,
        gridcolor: '#f5f5f5'
    },
    yaxis: {
        showgrid: true,
        gridcolor: '#f5f5f5',
        title: 'Trend Strength'
    }
};

Plotly.newPlot('trendChart', [trendData], trendLayout);

// Event listeners
document.getElementById('tradingPair').addEventListener('change', updatePriceChart);
document.getElementById('timeframe').addEventListener('change', updatePriceChart);

// Initial chart load
updatePriceChart();
</script>
{% endblock %} 