{% extends "layouts/base.html" %}

{% block title %}Trading Bot - Performance{% endblock %}

{% block header_text %}Performance Analytics{% endblock %}

{% block content %}
<div class="row">
    <!-- Total Trades -->
    <div class="col-md-3">
        <div class="dashboard-card">
            <h5><i class='bx bx-line-chart text-primary'></i> Trading</h5>
            <div class="mt-3">
                <h2 class="mb-0" id="total-trades">{{ performance_stats.total_trades }}</h2>
                <small class="text-muted">Total Trades</small>
            </div>
            <div class="mt-3">
                <span class="text-{{ 'success' if performance_stats.total_profit > 0 else 'danger' }}" id="total-profit">
                    <i class='bx bx-{{ 'up' if performance_stats.total_profit > 0 else 'down' }}-arrow-alt'></i> 
                    {{ "%.2f"|format(performance_stats.total_profit) }}
                </span>
                <small class="text-muted ms-2">Total Profit</small>
            </div>
        </div>
    </div>

    <!-- Win Rate -->
    <div class="col-md-3">
        <div class="dashboard-card">
            <h5><i class='bx bx-trophy text-success'></i> Win Rate</h5>
            <div class="mt-3">
                <h2 class="mb-0" id="win-rate">{{ "%.1f"|format(performance_stats.win_rate) }}%</h2>
                <small class="text-muted">Success Rate</small>
            </div>
            <div class="mt-3">
                <span class="text-info" id="winning-trades">
                    <i class='bx bx-check'></i> {{ performance_stats.winning_trades }}/{{ performance_stats.total_trades }}
                </span>
                <small class="text-muted ms-2">Winning Trades</small>
            </div>
        </div>
    </div>

    <!-- Average Performance -->
    <div class="col-md-3">
        <div class="dashboard-card">
            <h5><i class='bx bx-stats text-warning'></i> Averages</h5>
            <div class="mt-3">
                <h2 class="mb-0" id="avg-profit">{{ "%.2f"|format(performance_stats.average_profit) }}</h2>
                <small class="text-muted">Average Profit/Trade</small>
            </div>
            <div class="mt-3">
                <span class="text-success" id="avg-win">
                    <i class='bx bx-trending-up'></i> {{ "%.2f"|format(performance_stats.average_win) }}
                </span>
                <small class="text-muted ms-2">Avg Win</small>
                <span class="text-danger ms-3" id="avg-loss">
                    <i class='bx bx-trending-down'></i> {{ "%.2f"|format(performance_stats.average_loss) }}
                </span>
                <small class="text-muted ms-2">Avg Loss</small>
            </div>
        </div>
    </div>

    <!-- Profit Factor -->
    <div class="col-md-3">
        <div class="dashboard-card">
            <h5><i class='bx bx-calculator text-danger'></i> Risk Metrics</h5>
            <div class="mt-3">
                <h2 class="mb-0" id="profit-factor">{{ "%.2f"|format(performance_stats.profit_factor) }}</h2>
                <small class="text-muted">Profit Factor</small>
            </div>
            <div class="mt-3">
                <span class="text-success" id="largest-win">
                    <i class='bx bx-upside-down'></i> {{ "%.2f"|format(performance_stats.largest_win) }}
                </span>
                <small class="text-muted ms-2">Best Trade</small>
                <span class="text-danger ms-3" id="largest-loss">
                    <i class='bx bx-down-arrow-alt'></i> {{ "%.2f"|format(performance_stats.largest_loss) }}
                </span>
                <small class="text-muted ms-2">Worst Trade</small>
            </div>
        </div>
    </div>
</div>

<!-- Daily Performance -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h5>Daily Performance</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Trades</th>
                            <th>Win Rate</th>
                            <th>Profit/Loss</th>
                        </tr>
                    </thead>
                    <tbody id="daily-performance">
                        {% for day in daily_performance %}
                        <tr>
                            <td>{{ day.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ day.trades }}</td>
                            <td>{{ "%.1f"|format(day.win_rate) }}%</td>
                            <td class="text-{{ 'success' if day.profit > 0 else 'danger' }}">
                                {{ "%.2f"|format(day.profit) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Recent Trades -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h5>Recent Trades</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Entry Price</th>
                            <th>Exit Price</th>
                            <th>Quantity</th>
                            <th>P/L</th>
                        </tr>
                    </thead>
                    <tbody id="recent-trades">
                        {% for trade in recent_trades %}
                        <tr>
                            <td>{{ trade.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>{{ trade.symbol }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if trade.side == 'BUY' else 'danger' }}">
                                    {{ trade.side }}
                                </span>
                            </td>
                            <td>{{ "%.2f"|format(trade.entry_price) }}</td>
                            <td>{{ "%.2f"|format(trade.exit_price) }}</td>
                            <td>{{ "%.4f"|format(trade.quantity) }}</td>
                            <td class="text-{{ 'success' if trade.realized_pnl > 0 else 'danger' }}">
                                {{ "%.2f"|format(trade.realized_pnl) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 2000; // Start with 2 seconds
    let ws;

    function connectWebSocket() {
        ws = new WebSocket(`ws://${window.location.host}/ws`);
        
        ws.addEventListener('open', function (event) {
            console.log('Connected to WebSocket');
            reconnectAttempts = 0; // Reset attempts on successful connection
        });
        
        ws.addEventListener('message', function (event) {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                updatePerformanceStats(data.data.performance_stats);
                updateRecentTrades(data.data.recent_trades);
            }
        });
        
        ws.addEventListener('close', function (event) {
            console.log('Disconnected from WebSocket');
            attemptReconnect();
        });
        
        ws.addEventListener('error', function (event) {
            console.error('WebSocket error:', event);
        });
    }

    function attemptReconnect() {
        if (reconnectAttempts < maxReconnectAttempts) {
            const delay = reconnectDelay * Math.pow(2, reconnectAttempts);
            console.log(`Attempting to reconnect in ${delay/1000} seconds...`);
            setTimeout(() => {
                reconnectAttempts++;
                connectWebSocket();
            }, delay);
        } else {
            console.log('Max reconnection attempts reached. Please refresh the page manually.');
        }
    }
    
    // Initial connection
    connectWebSocket();
    
    // Keep connection alive with ping
    setInterval(function() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'ping' }));
        }
    }, 30000);
    
    function updatePerformanceStats(stats) {
        // Update statistics
        document.getElementById('total-trades').textContent = stats.total_trades;
        document.getElementById('win-rate').textContent = stats.win_rate.toFixed(1) + '%';
        document.getElementById('winning-trades').innerHTML = 
            `<i class='bx bx-check'></i> ${stats.winning_trades}/${stats.total_trades}`;
        
        // Update profit displays
        const totalProfitEl = document.getElementById('total-profit');
        totalProfitEl.innerHTML = 
            `<i class='bx bx-${stats.total_profit > 0 ? 'up' : 'down'}-arrow-alt'></i> ${stats.total_profit.toFixed(2)}`;
        totalProfitEl.className = `text-${stats.total_profit > 0 ? 'success' : 'danger'}`;
        
        // Update averages
        document.getElementById('avg-profit').textContent = stats.average_profit.toFixed(2);
        document.getElementById('avg-win').textContent = stats.average_win.toFixed(2);
        document.getElementById('avg-loss').textContent = stats.average_loss.toFixed(2);
        
        // Update risk metrics
        document.getElementById('profit-factor').textContent = stats.profit_factor.toFixed(2);
        document.getElementById('largest-win').textContent = stats.largest_win.toFixed(2);
        document.getElementById('largest-loss').textContent = stats.largest_loss.toFixed(2);
    }
    
    function updateRecentTrades(trades) {
        const tbody = document.getElementById('recent-trades');
        let html = '';
        
        trades.forEach(trade => {
            const timestamp = new Date(trade.timestamp).toLocaleString();
            html += `
                <tr>
                    <td>${timestamp}</td>
                    <td>${trade.symbol}</td>
                    <td>
                        <span class="badge bg-${trade.side === 'BUY' ? 'success' : 'danger'}">
                            ${trade.side}
                        </span>
                    </td>
                    <td>${trade.entry_price.toFixed(2)}</td>
                    <td>${trade.exit_price.toFixed(2)}</td>
                    <td>${trade.quantity.toFixed(4)}</td>
                    <td class="text-${trade.realized_pnl > 0 ? 'success' : 'danger'}">
                        ${trade.realized_pnl.toFixed(2)}
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
</script>
{% endblock %} 